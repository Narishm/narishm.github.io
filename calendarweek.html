<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VTuber Schedule – Week Bars (Sun–Sat)</title>

  <script src="js/config.js"></script>

  <style>
    :root {
      --bg: #000;
      --white: #fff;

      /* =========================
         BORDER SETTINGS
         ========================= */
      --borderColor: #fff;
      --borderSize: 4px; /* uniform border thickness */

      --blue1: #2e4b78;
      --blue2: #1f345a;

      --rowH: 92px;
      --rowGap: 15px;
      --pointGap: 15px;
      --sideW: 220px;

      /* Shape tuning */
      --slant: 26px;
      --point: 28px;

      /* Row offset tuning */
      --offset: 50px;

      /* Default (no-event) bar fallback */
      --barDefault: #2a3446;

      /* Middle text font */
      --midFont: "AleaWB", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    @font-face {
      font-family: "AleaWB";
      src: url("fnt/ALEAWB__.TTF") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); overflow-x: hidden; }

    body {
      display: grid;
      place-items: center;
      padding: 24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      width: min(1200px, 96vw);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: #fff;
    }

    .title {
      font-weight: 900;
      letter-spacing: .04em;
      text-transform: uppercase;
      font-size: 14px;
      opacity: .9;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background .12s ease, transform .06s ease;
      user-select: none;
    }
    .btn:hover { background: rgba(255,255,255,.10); }
    .btn:active { transform: translateY(1px); }

    .range {
      font-weight: 900;
      font-size: 14px;
      opacity: .95;
      text-shadow: 0 3px 0 rgba(0,0,0,.8);
    }

    .error {
      color: #fff;
      background: rgba(255,80,80,.16);
      border: 1px solid rgba(255,80,80,.40);
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
      display: none;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: var(--rowGap);
    }

    .row {
      height: var(--rowH);
      display: grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW);
      gap: 0px;
      align-items: stretch;
      transform: translateX(var(--rowShift, 0px));
      transition: transform .15s ease;
      overflow: visible;
    }

    .row.shift-left  { --rowShift: calc(var(--offset) * -1); }
    .row.shift-right { --rowShift: var(--offset); }

    /* =========================
       SHAPES
       - Fill is still CSS (clip-path)
       - Border is SVG stroke overlay (uniform thickness)
       ========================= */
    .shape {
      position: relative;
      overflow: visible;
      filter: drop-shadow(0 6px 0 rgba(0,0,0,0.80));
      min-height: 1px;
    }

    /* Fill layer */
    .shape::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* SVG stroke overlay */
    .strokeSvg {
      position: absolute;
      inset: 0;
      z-index: 4;
      pointer-events: none;
      overflow: visible;
    }
    .strokeSvg polygon {
      fill: none;
      stroke: var(--borderColor);
      stroke-width: var(--borderSize);
      vector-effect: non-scaling-stroke;
      stroke-linejoin: miter;
      stroke-miterlimit: 4;
    }

    .content-layer {
      position: relative;
      z-index: 5;
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 20px;
    }

    .arrow::after {
      clip-path: polygon(
        0% 50%,
        var(--point) 0%,
        100% 0%,
        calc(100% - var(--slant)) 100%,
        var(--point) 100%,
        0% 50%
      );
      background:
        url("img/06.png") 0 0 / auto repeat,
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
    }

    /* MIDDLE BAR */
    .bar {
      margin-left: calc(-1 * (var(--slant) - var(--pointGap)));
      --barPattern: none;
    }
    .bar::after {
      clip-path: polygon(
        var(--slant) 0%,
        100% 0%,
        calc(100% - var(--slant)) 100%,
        0% 100%
      );
      background:
        radial-gradient(120px 80px at 20% 30%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(0,0,0,.20)),
        var(--barPattern) 0 0 / auto repeat,
        var(--barDefault);
    }

    /* RIGHT BOX */
    .arrowR {
      margin-left: calc(-1 * (var(--slant) - var(--pointGap)));
      --thumb: none;
    }
    .arrowR::after {
      clip-path: polygon(
        var(--slant) 0%,
        calc(100% - var(--point)) 0%,
        100% 50%,
        calc(100% - var(--point)) 100%,
        0% 100%
      );
      background:
        var(--thumb) center/cover,
        linear-gradient(180deg, var(--blue1), var(--blue2));
    }

    /* text */
    .kanjiBox {
      width: 70px; height: 70px;
      display: grid; place-items: center;
      color: var(--white);
      font-weight: 900;
      font-size: 44px;
      line-height: 1;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.85));
      margin-right: 6px;
      flex: 0 0 auto;
    }

    /* NEW: day + date stack (centered, same size) */
    .dowWrap{
      display: flex;
      flex-direction: column;
      align-items: center;     /* centers date under day */
      text-align: center;
      line-height: 1;
      gap: 3px;
      transform: translateY(-3px);
      flex: 0 0 auto;
    }

    .dow {
      color: #fff;
      font-weight: 900;
      font-size: 32px;
      text-transform: uppercase;
      text-shadow: 0 4px 0 rgba(0,0,0,.85);
    }

    .date {
      color: #fff;
      font-weight: 900;
      font-size: 32px;         /* same size as .dow */
      text-transform: uppercase; /* optional; remove if you want 01/15 exactly */
      text-shadow: 0 4px 0 rgba(0,0,0,.85);
      letter-spacing: .02em;
      opacity: .95;
    }

    .eventTitle {
      flex: 1;
      font-family: var(--midFont);
      color: #fff;
      font-weight: 900;
      font-size: clamp(22px, 2.2vw, 44px);
      text-shadow: 0 5px 0 rgba(0,0,0,.85);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 0 10px;
    }

    .eventTime {
      font-family: var(--midFont);
      color: #fff;
      font-weight: 900;
      font-size: clamp(14px, 1.2vw, 22px);
      text-transform: uppercase;
      text-shadow: 0 4px 0 rgba(0,0,0,.85);
      white-space: nowrap;
      flex: 0 0 auto;
    }

    @media (max-width: 800px) {
      :root {
        --sideW: 200px;
        --rowH: 82px;
        --slant: 22px;
        --point: 24px;
        --offset: 16px;
      }
      .kanjiBox { width: 62px; height: 62px; font-size: 38px; }
      .dow { font-size: 28px; }
      .date { font-size: 28px; }
      .dowWrap { transform: translateY(-3px); gap: 3px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Weekly Schedule</div>
      <div class="controls">
        <button class="btn" id="prevBtn">◀ Prev</button>
        <button class="btn" id="todayBtn">This Week</button>
        <button class="btn" id="nextBtn">Next ▶</button>
        <div class="range" id="rangeLabel"></div>
      </div>
    </div>
    <div class="error" id="errorBox"></div>
    <div class="list" id="list"></div>
  </div>

<script>
const cfg = window.GCAL_CONFIG || {};
const GOOGLE_API_KEY = cfg.apiKey;
const CALENDAR_SHARE_LINK = cfg.calendarShareLink;

const IMAGE_BASE_URL = "img/";
const IMAGE_EXTENSION = ".png";

const DAYS = [
  { name:"sun", kanji:"日" }, { name:"mon", kanji:"月" }, { name:"tue", kanji:"火" },
  { name:"wed", kanji:"水" }, { name:"thu", kanji:"木" }, { name:"fri", kanji:"金" },
  { name:"sat", kanji:"土" },
];

const listEl = document.getElementById("list");
const rangeLabel = document.getElementById("rangeLabel");
const errorBox = document.getElementById("errorBox");

function showError(msg){ errorBox.style.display = "block"; errorBox.textContent = msg; }
function clearError(){ errorBox.style.display = "none"; errorBox.textContent = ""; }

function pad(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function startOfDayLocal(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate() + n); return x; }
function startOfWeekSunday(d){
  const x = startOfDayLocal(d);
  const start = new Date(x);
  start.setDate(x.getDate() - x.getDay());
  start.setHours(0,0,0,0);
  return start;
}

function formatRangeLabel(weekStart){
  const end = addDays(weekStart, 6);
  return `${weekStart.toLocaleDateString(undefined,{month:'short', day:'numeric'})} – ${end.toLocaleDateString(undefined,{month:'short', day:'numeric', year:'numeric'})}`;
}

function formatMMDD(d){
  return `${d.getMonth()+1}/${d.getDate()}`;
}

/* ✅ robust cid decode */
function padBase64(b64){ const mod=b64.length%4; return mod ? b64 + "=".repeat(4-mod) : b64; }
function decodeCidToCalendarId(cid){
  try { return atob(padBase64(cid.replace(/-/g,"+").replace(/_/g,"/"))); }
  catch { return null; }
}
function extractCalendarIdFromShareLink(urlStr){
  try {
    const u = new URL(urlStr);
    const cid = u.searchParams.get("cid");
    return cid ? decodeCidToCalendarId(cid) : null;
  } catch { return null; }
}

/* ✅ paging-safe fetch */
async function fetchAllEvents(calendarId, timeMinISO, timeMaxISO){
  const base = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`;
  let pageToken = null;
  const all = [];

  while(true){
    const url = new URL(base);
    url.searchParams.set("key", GOOGLE_API_KEY);
    url.searchParams.set("timeMin", timeMinISO);
    url.searchParams.set("timeMax", timeMaxISO);
    url.searchParams.set("singleEvents","true");
    url.searchParams.set("orderBy","startTime");
    url.searchParams.set("maxResults","2500");
    if(pageToken) url.searchParams.set("pageToken", pageToken);

    const res = await fetch(url.toString());
    const data = await res.json();
    if(!res.ok) throw new Error(data?.error?.message || "Calendar API error");

    if(Array.isArray(data.items)) all.push(...data.items);
    pageToken = data.nextPageToken;
    if(!pageToken) break;
  }

  return all;
}

/* ✅ multi-day coverage map (fixes Friday) */
function coveredDayKeys(ev){
  let start, endExclusive;

  if(ev?.start?.date){
    start = new Date(ev.start.date + "T00:00:00");
    endExclusive = ev?.end?.date ? new Date(ev.end.date + "T00:00:00")
                                 : new Date(start.getTime() + 86400000);
  } else if(ev?.start?.dateTime){
    start = new Date(ev.start.dateTime);
    endExclusive = ev?.end?.dateTime ? new Date(ev.end.dateTime)
                                     : new Date(start.getTime() + 3600000);
  } else {
    return [];
  }

  const startDay = startOfDayLocal(start);
  const lastTouched = new Date(endExclusive.getTime() - 1);
  const endDay = startOfDayLocal(lastTouched);

  const keys = [];
  for(let d = new Date(startDay); d <= endDay; d.setDate(d.getDate()+1)){
    keys.push(ymd(d));
  }
  return keys;
}

function isAllDay(ev){ return !!ev?.start?.date; }
function startMillis(ev){
  if(ev?.start?.dateTime) return new Date(ev.start.dateTime).getTime();
  if(ev?.start?.date) return new Date(ev.start.date + "T00:00:00").getTime();
  return Number.POSITIVE_INFINITY;
}
function sortEventsForDay(list){
  return list.sort((a,b)=>{
    const ad=isAllDay(a), bd=isAllDay(b);
    if(ad!==bd) return ad ? -1 : 1;
    const sa=startMillis(a), sb=startMillis(b);
    if(sa!==sb) return sa-sb;
    return String(a?.summary||"").localeCompare(String(b?.summary||""));
  });
}

function normalizeDescription(desc){
  const s = String(desc||"");
  const noHtml = s.replace(/<[^>]+>/g,"");
  const firstLine = noHtml.split(/\r?\n/)[0];
  return firstLine.trim();
}

/* packed code: "00off" */
function parsePackedCodeFromEvent(ev){
  const token = normalizeDescription(ev?.description || "").split(/\s+/)[0];
  const m = token.match(/^(\d{2})([A-Za-z0-9_-]+)$/);
  return m ? { barCode: m[1], thumbCode: m[2] } : { barCode: null, thumbCode: null };
}

function stripLeadingIndexPrefix(title){
  return String(title || "").replace(/^\s*\d+\s*-\s*/,"").trim();
}

function formatTimeOneLine(date){
  const raw = new Intl.DateTimeFormat(undefined,{hour:"numeric",minute:"2-digit"}).format(date);
  return raw.replace(":00","").toUpperCase();
}
function startsOnDay(ev, dayKey){
  if(ev?.start?.date) return ev.start.date === dayKey;
  if(ev?.start?.dateTime) return ymd(new Date(ev.start.dateTime)) === dayKey;
  return false;
}

function codeToImageUrl(code){
  return IMAGE_BASE_URL + encodeURIComponent(code) + IMAGE_EXTENSION;
}

function pickDriverEventForDay(list){
  const sorted = sortEventsForDay([...list]);
  for(const ev of sorted){
    const p = parsePackedCodeFromEvent(ev);
    if(p.barCode && p.thumbCode) return ev;
  }
  return sorted[0] || null;
}

/* =========================
   SVG STROKE BORDER (uniform)
   ========================= */
function cssPx(varName){
  const v = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  const n = parseFloat(v);
  return Number.isFinite(n) ? n : 0;
}

const strokeJobs = [];
function queueStroke(shapeEl, kind){
  strokeJobs.push({ el: shapeEl, kind });
}

function ensureStrokeSvg(shapeEl){
  let svg = shapeEl.querySelector(":scope > svg.strokeSvg");
  if(svg) return svg;

  svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.classList.add("strokeSvg");

  const poly = document.createElementNS("http://www.w3.org/2000/svg","polygon");
  svg.appendChild(poly);

  shapeEl.appendChild(svg);
  return svg;
}

function setPolygonPoints(poly, pts){
  poly.setAttribute("points", pts.map(p => `${p[0]},${p[1]}`).join(" "));
}

function applyStrokes(){
  const slant = cssPx("--slant");
  const point = cssPx("--point");

  while(strokeJobs.length){
    const { el, kind } = strokeJobs.shift();
    const w = el.clientWidth;
    const h = el.clientHeight;
    if(!w || !h) continue;

    const svg = ensureStrokeSvg(el);
    svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
    svg.setAttribute("preserveAspectRatio","none");

    const poly = svg.querySelector("polygon");

    if(kind === "arrowL"){
      setPolygonPoints(poly, [
        [0, h/2],
        [point, 0],
        [w, 0],
        [w - slant, h],
        [point, h],
        [0, h/2],
      ]);
    } else if(kind === "bar"){
      setPolygonPoints(poly, [
        [slant, 0],
        [w, 0],
        [w - slant, h],
        [0, h],
      ]);
    } else if(kind === "arrowR"){
      setPolygonPoints(poly, [
        [slant, 0],
        [w - point, 0],
        [w, h/2],
        [w - point, h],
        [0, h],
      ]);
    }
  }
}

function scheduleStrokeApply(){
  requestAnimationFrame(() => applyStrokes());
}
window.addEventListener("resize", () => scheduleStrokeApply());

function makeRow(day, dateText, title, timeText, rowIndex, barPatternUrl, thumbUrl){
  const row = document.createElement("div");
  row.className = `row ${rowIndex % 2 === 0 ? 'shift-left' : 'shift-right'}`;

  // Left
  const arrow = document.createElement("div");
  arrow.className = "shape arrow";
  const leftContent = document.createElement("div");
  leftContent.className = "content-layer";

  const kanji = document.createElement("div");
  kanji.className = "kanjiBox";
  kanji.textContent = day.kanji;

  const dowWrap = document.createElement("div");
  dowWrap.className = "dowWrap";

  const dow = document.createElement("div");
  dow.className = "dow";
  dow.textContent = day.name;

  const dateEl = document.createElement("div");
  dateEl.className = "date";
  dateEl.textContent = dateText;

  dowWrap.appendChild(dow);
  dowWrap.appendChild(dateEl);

  leftContent.appendChild(kanji);
  leftContent.appendChild(dowWrap);
  arrow.appendChild(leftContent);

  // Center
  const bar = document.createElement("div");
  bar.className = "shape bar";
  if(barPatternUrl){
    bar.style.setProperty("--barPattern", `url("${barPatternUrl.replace(/"/g,'\\"')}")`);
  }
  const midContent = document.createElement("div");
  midContent.className = "content-layer";
  const eventTitle = document.createElement("div");
  eventTitle.className = "eventTitle";
  eventTitle.textContent = title;
  midContent.appendChild(eventTitle);
  if(timeText){
    const eventTime = document.createElement("div");
    eventTime.className = "eventTime";
    eventTime.textContent = timeText;
    midContent.appendChild(eventTime);
  }
  bar.appendChild(midContent);

  // Right
  const arrowR = document.createElement("div");
  arrowR.className = "shape arrowR";
  if(thumbUrl){
    arrowR.style.setProperty("--thumb", `url("${thumbUrl.replace(/"/g,'\\"')}")`);
  }

  row.appendChild(arrow);
  row.appendChild(bar);
  row.appendChild(arrowR);

  // Queue uniform SVG borders
  queueStroke(arrow, "arrowL");
  queueStroke(bar, "bar");
  queueStroke(arrowR, "arrowR");

  return row;
}

let cursorDate = new Date();

async function refreshWeek(){
  clearError();
  listEl.innerHTML = "";

  if(!window.GCAL_CONFIG) return showError("Missing js/config.js (window.GCAL_CONFIG not found).");
  if(!GOOGLE_API_KEY || !CALENDAR_SHARE_LINK) return showError("js/config.js must provide { apiKey, calendarShareLink }.");

  const calendarId = extractCalendarIdFromShareLink(CALENDAR_SHARE_LINK);
  if(!calendarId) return showError("Invalid Calendar Link (cid decode failed).");

  const weekStart = startOfWeekSunday(cursorDate);
  const weekEndExclusive = addDays(weekStart, 7);
  rangeLabel.textContent = formatRangeLabel(weekStart);

  try {
    const events = await fetchAllEvents(calendarId, weekStart.toISOString(), weekEndExclusive.toISOString());

    // ✅ map using coverage, not start date
    const byDay = new Map();
    for(const ev of events){
      for(const k of coveredDayKeys(ev)){
        if(!byDay.has(k)) byDay.set(k, []);
        byDay.get(k).push(ev);
      }
    }

    for(let i=0; i<7; i++){
      const dayDate = addDays(weekStart, i);
      const dayKey = ymd(dayDate);
      const mmdd = formatMMDD(dayDate);

      const evs = byDay.get(dayKey) || [];
      const driver = evs.length ? pickDriverEventForDay(evs) : null;

      let title = "Rest Day";
      let timeText = "";
      let barPatternUrl = null;
      let thumbUrl = null;

      if(driver){
        const parsed = parsePackedCodeFromEvent(driver);
        const summary = stripLeadingIndexPrefix(String(driver.summary || "").trim());
        title = summary || (parsed.thumbCode ? parsed.thumbCode : "Untitled");

        if(parsed.barCode) barPatternUrl = codeToImageUrl(parsed.barCode);
        if(parsed.thumbCode) thumbUrl = codeToImageUrl(parsed.thumbCode);

        if(driver.start?.dateTime && startsOnDay(driver, dayKey)){
          timeText = formatTimeOneLine(new Date(driver.start.dateTime));
        }
      }

      listEl.appendChild(makeRow(DAYS[i], mmdd, title, timeText, i, barPatternUrl, thumbUrl));
    }

    // Apply after DOM has actual sizes
    scheduleStrokeApply();

  } catch(e) {
    showError(e?.message || String(e));
  }
}

document.getElementById("todayBtn").onclick = () => { cursorDate = new Date(); refreshWeek(); };
document.getElementById("prevBtn").onclick = () => { cursorDate = addDays(startOfWeekSunday(cursorDate), -7); refreshWeek(); };
document.getElementById("nextBtn").onclick = () => { cursorDate = addDays(startOfWeekSunday(cursorDate), 7); refreshWeek(); };

refreshWeek();
</script>
</body>
</html>
