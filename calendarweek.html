<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VTuber Schedule – Week Bars (Sun–Sat)</title>

  <script src="js/config.js"></script>

  <style>
    :root {
      --bg: #000;
      --white: #fff;

      /* =========================
         BORDER SETTINGS
         ========================= */
      --borderColor: #fff;
      --borderSize: 5; /* ✅ number (no px). 5 = about 5px outside stroke */
      --borderScaleK: 0.012; /* tweak: 0.010–0.015 if you want */

      --blue1: #2e4b78;
      --blue2: #1f345a;

      --rowH: 92px;
      --rowGap: 15px;
      --pointGap: 15px;
      --sideW: 220px;

      /* Shape tuning */
      --slant: 26px;
      --point: 28px;

      /* Row offset tuning */
      --offset: 50px;
      --barDefault: #2a3446;
      --midFont: "AleaWB", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    @font-face {
      font-family: "AleaWB";
      src: url("fnt/ALEAWB__.TTF") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); overflow-x: hidden; }

    body {
      display: grid;
      place-items: center;
      padding: 24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      width: min(1200px, 96vw);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: #fff;
    }

    .title {
      font-weight: 900;
      letter-spacing: .04em;
      text-transform: uppercase;
      font-size: 14px;
      opacity: .9;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background .12s ease, transform .06s ease;
      user-select: none;
    }
    .btn:hover { background: rgba(255,255,255,.10); }
    .btn:active { transform: translateY(1px); }

    .range {
      font-weight: 900;
      font-size: 14px;
      opacity: .95;
      text-shadow: 0 3px 0 rgba(0,0,0,.8);
    }

    .error {
      color: #fff;
      background: rgba(255,80,80,.16);
      border: 1px solid rgba(255,80,80,.40);
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
      display: none;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: var(--rowGap);
    }

    .row {
      height: var(--rowH);
      display: grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW);
      gap: 0px;
      align-items: stretch;
      transform: translateX(var(--rowShift, 0px));
      transition: transform .15s ease;
      overflow: visible;
    }

    .row.shift-left  { --rowShift: calc(var(--offset) * -1); }
    .row.shift-right { --rowShift: var(--offset); }

    /* ✅ critical: stack order so outside borders don't get covered by overlaps */
    .cell { position: relative; }
    .z3 { z-index: 30; }
    .z2 { z-index: 20; }
    .z1 { z-index: 10; }

    /* =========================
       OUTSIDE BORDER CORE LOGIC
       ========================= */
    .shape-container {
      position: relative;
      overflow: visible;
      filter: drop-shadow(0 6px 0 rgba(0,0,0,0.8));
    }

    /* OUTSIDE BORDER LAYER */
    .shape-container::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--borderColor);
      z-index: 0;
      pointer-events: none;

      /* scale outward; borderSize is a number */
      transform: scale(calc(1 + (var(--borderSize) * var(--borderScaleK))));
      transform-origin: center;
    }

    /* FILL LAYER */
    .shape-container::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* =========================
       SHAPES (clip-path applied to BOTH ::before border and ::after fill)
       ========================= */

    /* LEFT BOX */
    .arrow::before,
    .arrow::after {
      clip-path: polygon(
        0% 50%,
        var(--point) 0%,
        100% 0%,
        calc(100% - var(--slant)) 100%,
        var(--point) 100%,
        0% 50%
      );
    }
    .arrow::after {
      background:
        url("img/06.png") 0 0 / auto repeat,
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
    }

    /* MIDDLE BAR */
    .bar {
      margin-left: calc(-1 * (var(--slant) - var(--pointGap)));
    }
    .bar::before,
    .bar::after {
      clip-path: polygon(
        var(--slant) 0%,
        100% 0%,
        calc(100% - var(--slant)) 100%,
        0% 100%
      );
    }
    .bar::after {
      background:
        var(--barPattern, none) center/cover,
        var(--barColor, var(--barDefault));
    }

    /* RIGHT BOX */
    .arrowR {
      margin-left: calc(-1 * (var(--slant) - var(--pointGap)));
    }
    .arrowR::before,
    .arrowR::after {
      clip-path: polygon(
        var(--slant) 0%,
        calc(100% - var(--point)) 0%,
        100% 50%,
        calc(100% - var(--point)) 100%,
        0% 100%
      );
    }
    .arrowR::after {
      background:
        var(--thumb, none) center/cover,
        linear-gradient(180deg, var(--blue1), var(--blue2));
    }

    .content-layer {
      position: relative;
      z-index: 5;
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 20px;
    }

    .kanjiBox {
      width: 70px; height: 70px; display: grid; place-items: center;
      color: var(--white); font-weight: 900; font-size: 44px;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.85));
    }

    .dow {
      color: #fff; font-weight: 900; font-size: 32px;
      text-transform: uppercase; text-shadow: 0 4px 0 rgba(0,0,0,.85);
    }

    .eventTitle {
      flex: 1; font-family: var(--midFont); color: #fff; font-weight: 900;
      font-size: clamp(22px, 2.2vw, 44px); text-shadow: 0 5px 0 rgba(0,0,0,.85);
      text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .eventTime {
      font-family: var(--midFont); color: #fff; font-weight: 900;
      font-size: clamp(14px, 1.2vw, 22px); text-transform: uppercase;
      text-shadow: 0 4px 0 rgba(0,0,0,.85);
    }

    @media (max-width: 800px) {
      :root { --sideW: 200px; --rowH: 82px; --slant: 22px; --point: 24px; --offset: 16px; }
      .kanjiBox { width: 62px; height: 62px; font-size: 38px; }
      .dow { font-size: 28px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Weekly Schedule</div>
      <div class="controls">
        <button class="btn" id="prevBtn">◀ Prev</button>
        <button class="btn" id="todayBtn">This Week</button>
        <button class="btn" id="nextBtn">Next ▶</button>
        <div class="range" id="rangeLabel"></div>
      </div>
    </div>
    <div class="error" id="errorBox"></div>
    <div class="list" id="list"></div>
  </div>

<script>
const cfg = window.GCAL_CONFIG || {};
const GOOGLE_API_KEY = cfg.apiKey;
const CALENDAR_SHARE_LINK = cfg.calendarShareLink;
const IMAGE_BASE_URL = "img/";
const IMAGE_EXTENSION = ".png";

const DAYS = [
  { name:"sun", kanji:"日" }, { name:"mon", kanji:"月" }, { name:"tue", kanji:"火" },
  { name:"wed", kanji:"水" }, { name:"thu", kanji:"木" }, { name:"fri", kanji:"金" },
  { name:"sat", kanji:"土" },
];

const listEl = document.getElementById("list");
const rangeLabel = document.getElementById("rangeLabel");
const errorBox = document.getElementById("errorBox");

function showError(msg){ errorBox.style.display = "block"; errorBox.textContent = msg; }
function clearError(){ errorBox.style.display = "none"; }
function pad(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function startOfDayLocal(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate() + n); return x; }
function startOfWeekSunday(d){
  const x = startOfDayLocal(d);
  const start = new Date(x);
  start.setDate(x.getDate() - x.getDay());
  start.setHours(0,0,0,0);
  return start;
}

function formatRangeLabel(weekStart){
  const end = addDays(weekStart, 6);
  return `${weekStart.toLocaleDateString(undefined,{month:'short', day:'numeric'})} – ${end.toLocaleDateString(undefined,{month:'short', day:'numeric', year:'numeric'})}`;
}

function extractCalendarIdFromShareLink(urlStr){
  try {
    const u = new URL(urlStr);
    const cid = u.searchParams.get("cid");
    if(!cid) return null;
    return atob(cid.replace(/-/g,"+").replace(/_/g,"/"));
  } catch { return null; }
}

async function fetchAllEvents(calendarId, timeMinISO, timeMaxISO){
  const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events?key=${GOOGLE_API_KEY}&timeMin=${timeMinISO}&timeMax=${timeMaxISO}&singleEvents=true&orderBy=startTime`;
  const res = await fetch(url);
  const data = await res.json();
  if(!res.ok) throw new Error(data?.error?.message || "API Error");
  return data.items || [];
}

function parsePackedCodeFromEvent(ev){
  const desc = String(ev?.description || "").replace(/<[^>]+>/g,"").trim();
  const m = desc.split(/\s+/)[0].match(/^(\d{2})([A-Za-z0-9_-]+)$/);
  return m ? { barCode: m[1], thumbCode: m[2] } : { barCode: null, thumbCode: null };
}

function makeRow(day, title, timeText, rowIndex, barPatternUrl, thumbUrl){
  const row = document.createElement("div");
  row.className = `row ${rowIndex % 2 === 0 ? 'shift-left' : 'shift-right'}`;

  // Left Arrow (topmost)
  const arrow = document.createElement("div");
  arrow.className = "cell z3 shape-container arrow";
  arrow.innerHTML = `<div class="content-layer"><div class="kanjiBox">${day.kanji}</div><div class="dow">${day.name}</div></div>`;

  // Center Bar (middle)
  const bar = document.createElement("div");
  bar.className = "cell z2 shape-container bar";
  if(barPatternUrl) bar.style.setProperty("--barPattern", `url("${barPatternUrl}")`);
  bar.innerHTML = `<div class="content-layer"><div class="eventTitle">${title}</div>${timeText ? `<div class="eventTime">${timeText}</div>`:''}</div>`;

  // Right Arrow (bottom)
  const arrowR = document.createElement("div");
  arrowR.className = "cell z1 shape-container arrowR";
  if(thumbUrl) arrowR.style.setProperty("--thumb", `url("${thumbUrl}")`);

  row.append(arrow, bar, arrowR);
  return row;
}

let cursorDate = new Date();

async function refreshWeek(){
  clearError();
  listEl.innerHTML = "";
  const calendarId = extractCalendarIdFromShareLink(CALENDAR_SHARE_LINK);
  if(!calendarId) return showError("Invalid Calendar Link");

  const weekStart = startOfWeekSunday(cursorDate);
  rangeLabel.textContent = formatRangeLabel(weekStart);

  try {
    const events = await fetchAllEvents(calendarId, weekStart.toISOString(), addDays(weekStart, 7).toISOString());
    const byDay = {};
    events.forEach(ev => {
      const d = ev.start.dateTime ? new Date(ev.start.dateTime) : new Date(ev.start.date + "T00:00:00");
      const k = ymd(d);
      if(!byDay[k]) byDay[k] = [];
      byDay[k].push(ev);
    });

    for(let i=0; i<7; i++){
      const dayDate = addDays(weekStart, i);
      const evs = byDay[ymd(dayDate)] || [];
      const driver = evs[0];
      let title = "Rest Day", time = "", bPat = null, tPat = null;

      if(driver){
        const parsed = parsePackedCodeFromEvent(driver);
        title = driver.summary;
        if(parsed.barCode) bPat = IMAGE_BASE_URL + parsed.barCode + IMAGE_EXTENSION;
        if(parsed.thumbCode) tPat = IMAGE_BASE_URL + parsed.thumbCode + IMAGE_EXTENSION;
        if(driver.start.dateTime) time = new Intl.DateTimeFormat(undefined, {hour:'numeric', minute:'2-digit'}).format(new Date(driver.start.dateTime));
      }
      listEl.appendChild(makeRow(DAYS[i], title, time, i, bPat, tPat));
    }
  } catch(e) { showError(e.message); }
}

document.getElementById("todayBtn").onclick = () => { cursorDate = new Date(); refreshWeek(); };
document.getElementById("prevBtn").onclick = () => { cursorDate = addDays(cursorDate, -7); refreshWeek(); };
document.getElementById("nextBtn").onclick = () => { cursorDate = addDays(cursorDate, 7); refreshWeek(); };

refreshWeek();
</script>
</body>
</html>
