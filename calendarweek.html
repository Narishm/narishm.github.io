<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>VTuber Schedule – Week Bars (Sun–Sat)</title>

  <script src="js/config.js"></script>

  <style>
    :root {
      --bg: #000;
      --white: #fff;

      /* =========================
         BORDER SETTINGS
         ========================= */
      --borderColor: #fff;
      --borderSize: 5px; /* ✅ uniform outside stroke */

      --blue1: #2e4b78;
      --blue2: #1f345a;

      --rowH: 92px;
      --rowGap: 15px;
      --pointGap: 15px;
      --sideW: 220px;

      /* Shape tuning */
      --slant: 26px;
      --point: 28px;

      /* Row offset tuning */
      --offset: 50px;
      --barDefault: #2a3446;
      --midFont: "AleaWB", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    @font-face {
      font-family: "AleaWB";
      src: url("fnt/ALEAWB__.TTF") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); overflow-x: hidden; }

    body {
      display: grid;
      place-items: center;
      padding: 24px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      width: min(1200px, 96vw);
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      color: #fff;
    }

    .title {
      font-weight: 900;
      letter-spacing: .04em;
      text-transform: uppercase;
      font-size: 14px;
      opacity: .9;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: background .12s ease, transform .06s ease;
      user-select: none;
    }
    .btn:hover { background: rgba(255,255,255,.10); }
    .btn:active { transform: translateY(1px); }

    .range {
      font-weight: 900;
      font-size: 14px;
      opacity: .95;
      text-shadow: 0 3px 0 rgba(0,0,0,.8);
    }

    .error {
      color: #fff;
      background: rgba(255,80,80,.16);
      border: 1px solid rgba(255,80,80,.40);
      border-radius: 12px;
      padding: 10px 12px;
      white-space: pre-wrap;
      display: none;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: var(--rowGap);
    }

    .row {
      height: var(--rowH);
      display: grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW);
      gap: 0px;
      align-items: stretch;
      transform: translateX(var(--rowShift, 0px));
      transition: transform .15s ease;
      overflow: visible;
    }

    .row.shift-left  { --rowShift: calc(var(--offset) * -1); }
    .row.shift-right { --rowShift: var(--offset); }

    /* ✅ needed because cells overlap (negative margins) */
    .cell { position: relative; }
    .z3 { z-index: 30; }
    .z2 { z-index: 20; }
    .z1 { z-index: 10; }

    /* =========================
       OUTSIDE BORDER (NO SCALING)
       ========================= */
    .shape-container {
      position: relative;
      overflow: visible;
      /* depth shadow */
      filter: drop-shadow(0 6px 0 rgba(0,0,0,0.80));
    }

    /* Border layer = SAME SHAPE, then we "stroke" it outward via drop-shadows */
    .shape-container::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--borderColor);
      z-index: 0;
      pointer-events: none;

      /* ✅ outside stroke approximation: 1..5px in 8 directions (uniform-looking) */
      filter:
        drop-shadow( 1px  0px 0 var(--borderColor))
        drop-shadow(-1px  0px 0 var(--borderColor))
        drop-shadow( 0px  1px 0 var(--borderColor))
        drop-shadow( 0px -1px 0 var(--borderColor))
        drop-shadow( 1px  1px 0 var(--borderColor))
        drop-shadow(-1px  1px 0 var(--borderColor))
        drop-shadow( 1px -1px 0 var(--borderColor))
        drop-shadow(-1px -1px 0 var(--borderColor))

        drop-shadow( 2px  0px 0 var(--borderColor))
        drop-shadow(-2px  0px 0 var(--borderColor))
        drop-shadow( 0px  2px 0 var(--borderColor))
        drop-shadow( 0px -2px 0 var(--borderColor))
        drop-shadow( 2px  2px 0 var(--borderColor))
        drop-shadow(-2px  2px 0 var(--borderColor))
        drop-shadow( 2px -2px 0 var(--borderColor))
        drop-shadow(-2px -2px 0 var(--borderColor))

        drop-shadow( 3px  0px 0 var(--borderColor))
        drop-shadow(-3px  0px 0 var(--borderColor))
        drop-shadow( 0px  3px 0 var(--borderColor))
        drop-shadow( 0px -3px 0 var(--borderColor))
        drop-shadow( 3px  3px 0 var(--borderColor))
        drop-shadow(-3px  3px 0 var(--borderColor))
        drop-shadow( 3px -3px 0 var(--borderColor))
        drop-shadow(-3px -3px 0 var(--borderColor))

        drop-shadow( 4px  0px 0 var(--borderColor))
        drop-shadow(-4px  0px 0 var(--borderColor))
        drop-shadow( 0px  4px 0 var(--borderColor))
        drop-shadow( 0px -4px 0 var(--borderColor))
        drop-shadow( 4px  4px 0 var(--borderColor))
        drop-shadow(-4px  4px 0 var(--borderColor))
        drop-shadow( 4px -4px 0 var(--borderColor))
        drop-shadow(-4px -4px 0 var(--borderColor))

        drop-shadow( 5px  0px 0 var(--borderColor))
        drop-shadow(-5px  0px 0 var(--borderColor))
        drop-shadow( 0px  5px 0 var(--borderColor))
        drop-shadow( 0px -5px 0 var(--borderColor))
        drop-shadow( 5px  5px 0 var(--borderColor))
        drop-shadow(-5px  5px 0 var(--borderColor))
        drop-shadow( 5px -5px 0 var(--borderColor))
        drop-shadow(-5px -5px 0 var(--borderColor));
    }

    /* Fill layer */
    .shape-container::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* LEFT BOX */
    .arrow::before,
    .arrow::after {
      clip-path: polygon(
        0% 50%,
        var(--point) 0%,
        100% 0%,
        calc(100% - var(--slant)) 100%,
        var(--point) 100%,
        0% 50%
      );
    }
    .arrow::after {
      background:
        url("img/06.png") 0 0 / auto repeat,
        linear-gradient(135deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
    }

    /* MIDDLE BAR */
    .bar {
      margin-left: calc(-1 * (var(--slant) - var(--pointGap)));
    }
    .bar::before,
    .bar::after {
      clip-path: polygon(
        var(--slant) 0%,
        100% 0%,
        calc(100% - var(--slant)) 100%,
        0% 100%
      );
    }
    .bar::after {
      background:
        var(--barPattern, none) 0 0 / auto repeat,
        var(--barColor, var(--barDefault));
    }

    /* RIGHT BOX */
    .arrowR {
      margin-left: calc(-1 * (var(--slant) - var(--pointGap)));
    }
    .arrowR::before,
    .arrowR::after {
      clip-path: polygon(
        var(--slant) 0%,
        calc(100% - var(--point)) 0%,
        100% 50%,
        calc(100% - var(--point)) 100%,
        0% 100%
      );
    }
    .arrowR::after {
      background:
        var(--thumb, none) center/cover,
        linear-gradient(180deg, var(--blue1), var(--blue2));
    }

    .content-layer {
      position: relative;
      z-index: 5;
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 20px;
    }

    .kanjiBox {
      width: 70px; height: 70px; display: grid; place-items: center;
      color: var(--white); font-weight: 900; font-size: 44px;
      filter: drop-shadow(0 2px 0 rgba(0,0,0,.85));
    }

    .dow {
      color: #fff; font-weight: 900; font-size: 32px;
      text-transform: uppercase; text-shadow: 0 4px 0 rgba(0,0,0,.85);
    }

    .eventTitle {
      flex: 1; font-family: var(--midFont); color: #fff; font-weight: 900;
      font-size: clamp(22px, 2.2vw, 44px); text-shadow: 0 5px 0 rgba(0,0,0,.85);
      text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .eventTime {
      font-family: var(--midFont); color: #fff; font-weight: 900;
      font-size: clamp(14px, 1.2vw, 22px); text-transform: uppercase;
      text-shadow: 0 4px 0 rgba(0,0,0,.85);
      white-space: nowrap;
    }

    @media (max-width: 800px) {
      :root { --sideW: 200px; --rowH: 82px; --slant: 22px; --point: 24px; --offset: 16px; }
      .kanjiBox { width: 62px; height: 62px; font-size: 38px; }
      .dow { font-size: 28px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Weekly Schedule</div>
      <div class="controls">
        <button class="btn" id="prevBtn">◀ Prev</button>
        <button class="btn" id="todayBtn">This Week</button>
        <button class="btn" id="nextBtn">Next ▶</button>
        <div class="range" id="rangeLabel"></div>
      </div>
    </div>
    <div class="error" id="errorBox"></div>
    <div class="list" id="list"></div>
  </div>

<script>
const cfg = window.GCAL_CONFIG || {};
const GOOGLE_API_KEY = cfg.apiKey;
const CALENDAR_SHARE_LINK = cfg.calendarShareLink;
const IMAGE_BASE_URL = "img/";
const IMAGE_EXTENSION = ".png";

const DAYS = [
  { name:"sun", kanji:"日" }, { name:"mon", kanji:"月" }, { name:"tue", kanji:"火" },
  { name:"wed", kanji:"水" }, { name:"thu", kanji:"木" }, { name:"fri", kanji:"金" },
  { name:"sat", kanji:"土" },
];

const listEl = document.getElementById("list");
const rangeLabel = document.getElementById("rangeLabel");
const errorBox = document.getElementById("errorBox");

function showError(msg){ errorBox.style.display = "block"; errorBox.textContent = msg; }
function clearError(){ errorBox.style.display = "none"; errorBox.textContent = ""; }

function pad(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function startOfDayLocal(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate() + n); return x; }
function startOfWeekSunday(d){
  const x = startOfDayLocal(d);
  const start = new Date(x);
  start.setDate(x.getDate() - x.getDay());
  start.setHours(0,0,0,0);
  return start;
}

function formatRangeLabel(weekStart){
  const end = addDays(weekStart, 6);
  return `${weekStart.toLocaleDateString(undefined,{month:'short', day:'numeric'})} – ${end.toLocaleDateString(undefined,{month:'short', day:'numeric', year:'numeric'})}`;
}

/* cid decode => calendarId */
function padBase64(b64){ const mod=b64.length%4; return mod ? b64 + "=".repeat(4-mod) : b64; }
function decodeCidToCalendarId(cid){
  try { const n=cid.replace(/-/g,"+").replace(/_/g,"/"); return atob(padBase64(n)); }
  catch { return null; }
}
function extractCalendarIdFromShareLink(urlStr){
  try {
    const u = new URL(urlStr);
    const cid = u.searchParams.get("cid");
    return cid ? decodeCidToCalendarId(cid) : null;
  } catch { return null; }
}

async function fetchAllEvents(calendarId, timeMinISO, timeMaxISO){
  const base = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calendarId)}/events`;
  const url = new URL(base);
  url.searchParams.set("key", GOOGLE_API_KEY);
  url.searchParams.set("timeMin", timeMinISO);
  url.searchParams.set("timeMax", timeMaxISO);
  url.searchParams.set("singleEvents", "true");
  url.searchParams.set("orderBy", "startTime");

  const res = await fetch(url.toString());
  const data = await res.json();
  if(!res.ok) throw new Error(data?.error?.message || "API Error");
  return data.items || [];
}

/* ✅ multi-day overlap */
function coveredDayKeys(ev){
  let start, endExclusive;

  if(ev?.start?.date){
    start = new Date(ev.start.date + "T00:00:00");
    endExclusive = ev?.end?.date ? new Date(ev.end.date + "T00:00:00")
                                 : new Date(start.getTime() + 86400000);
  } else if(ev?.start?.dateTime){
    start = new Date(ev.start.dateTime);
    endExclusive = ev?.end?.dateTime ? new Date(ev.end.dateTime)
                                     : new Date(start.getTime() + 3600000);
  } else {
    return [];
  }

  const startDay = startOfDayLocal(start);
  const lastTouched = new Date(endExclusive.getTime() - 1);
  const endDay = startOfDayLocal(lastTouched);

  const keys = [];
  for(let d = new Date(startDay); d <= endDay; d.setDate(d.getDate()+1)){
    keys.push(ymd(d));
  }
  return keys;
}

function isAllDay(ev){ return !!ev?.start?.date; }
function startMillis(ev){
  if(ev?.start?.dateTime) return new Date(ev.start.dateTime).getTime();
  if(ev?.start?.date) return new Date(ev.start.date + "T00:00:00").getTime();
  return Number.POSITIVE_INFINITY;
}
function sortEventsForDay(list){
  return list.sort((a,b)=>{
    const ad=isAllDay(a), bd=isAllDay(b);
    if(ad!==bd) return ad ? -1 : 1;
    const sa=startMillis(a), sb=startMillis(b);
    if(sa!==sb) return sa-sb;
    return String(a?.summary||"").localeCompare(String(b?.summary||""));
  });
}

function normalizeDescription(desc){
  const s = String(desc||"");
  const noHtml = s.replace(/<[^>]+>/g,"");
  const firstLine = noHtml.split(/\r?\n/)[0];
  return firstLine.trim();
}

/* packed code: "00off" */
function parsePackedCodeFromEvent(ev){
  const token = normalizeDescription(ev?.description || "").split(/\s+/)[0];
  const m = token.match(/^(\d{2})([A-Za-z0-9_-]+)$/);
  return m ? { barCode: m[1], thumbCode: m[2] } : { barCode: null, thumbCode: null };
}

function safeUrl(code){
  return IMAGE_BASE_URL + encodeURIComponent(code) + IMAGE_EXTENSION;
}

function formatTimeOneLine(date){
  const raw = new Intl.DateTimeFormat(undefined,{hour:"numeric",minute:"2-digit"}).format(date);
  return raw.replace(":00","").toUpperCase();
}
function startsOnDay(ev, dayKey){
  if(ev?.start?.date) return ev.start.date === dayKey;
  if(ev?.start?.dateTime) return ymd(new Date(ev.start.dateTime)) === dayKey;
  return false;
}

function makeRow(day, title, timeText, rowIndex, barPatternUrl, thumbUrl){
  const row = document.createElement("div");
  row.className = `row ${rowIndex % 2 === 0 ? 'shift-left' : 'shift-right'}`;

  // Left Arrow (topmost)
  const arrow = document.createElement("div");
  arrow.className = "cell z3 shape-container arrow";
  arrow.innerHTML = `<div class="content-layer"><div class="kanjiBox">${day.kanji}</div><div class="dow">${day.name}</div></div>`;

  // Center Bar (middle)
  const bar = document.createElement("div");
  bar.className = "cell z2 shape-container bar";
  if(barPatternUrl) bar.style.setProperty("--barPattern", `url("${barPatternUrl}")`);
  bar.innerHTML = `<div class="content-layer"><div class="eventTitle">${title}</div>${timeText ? `<div class="eventTime">${timeText}</div>` : ''}</div>`;

  // Right Arrow (bottom)
  const arrowR = document.createElement("div");
  arrowR.className = "cell z1 shape-container arrowR";
  if(thumbUrl) arrowR.style.setProperty("--thumb", `url("${thumbUrl}")`);

  row.append(arrow, bar, arrowR);
  return row;
}

function pickDriverEventForDay(list){
  const sorted = sortEventsForDay([...list]);
  // prefer one with packed codes
  for(const ev of sorted){
    const p = parsePackedCodeFromEvent(ev);
    if(p.barCode && p.thumbCode) return ev;
  }
  return sorted[0] || null;
}

let cursorDate = new Date();

async function refreshWeek(){
  clearError();
  listEl.innerHTML = "";

  if(!window.GCAL_CONFIG) return showError("Missing js/config.js (window.GCAL_CONFIG not found).");
  if(!GOOGLE_API_KEY || !CALENDAR_SHARE_LINK) return showError("js/config.js must provide { apiKey, calendarShareLink }.");

  const calendarId = extractCalendarIdFromShareLink(CALENDAR_SHARE_LINK);
  if(!calendarId) return showError("Invalid Calendar Link");

  const weekStart = startOfWeekSunday(cursorDate);
  const weekEndExclusive = addDays(weekStart, 7);
  rangeLabel.textContent = formatRangeLabel(weekStart);

  try {
    const events = await fetchAllEvents(calendarId, weekStart.toISOString(), weekEndExclusive.toISOString());

    // ✅ build map with coverage
    const byDay = new Map();
    for(const ev of events){
      for(const k of coveredDayKeys(ev)){
        if(!byDay.has(k)) byDay.set(k, []);
        byDay.get(k).push(ev);
      }
    }

    for(let i=0; i<7; i++){
      const dayDate = addDays(weekStart, i);
      const dayKey = ymd(dayDate);
      const evs = byDay.get(dayKey) || [];

      const driver = evs.length ? pickDriverEventForDay(evs) : null;

      let title = "Rest Day";
      let timeText = "";
      let barPatternUrl = null;
      let thumbUrl = null;

      if(driver){
        const parsed = parsePackedCodeFromEvent(driver);
        title = String(driver.summary || "").trim() || "Untitled";

        if(parsed.barCode) barPatternUrl = safeUrl(parsed.barCode);
        if(parsed.thumbCode) thumbUrl = safeUrl(parsed.thumbCode);

        if(driver.start?.dateTime && startsOnDay(driver, dayKey)){
          timeText = formatTimeOneLine(new Date(driver.start.dateTime));
        }
      }

      listEl.appendChild(makeRow(DAYS[i], title, timeText, i, barPatternUrl, thumbUrl));
    }

  } catch(e) {
    showError(e?.message || String(e));
  }
}

document.getElementById("todayBtn").onclick = () => { cursorDate = new Date(); refreshWeek(); };
document.getElementById("prevBtn").onclick = () => { cursorDate = addDays(startOfWeekSunday(cursorDate), -7); refreshWeek(); };
document.getElementById("nextBtn").onclick = () => { cursorDate = addDays(startOfWeekSunday(cursorDate), 7); refreshWeek(); };

refreshWeek();
</script>
</body>
</html>
